# My aws - データボリュームコンテナ編

@kaotil

2016/00/00



## やりたい事

- データボリュームコンテナにソースを設置したい
- apache + php の1コンテナにしたい
- apache + php のコンテナからデータボリュームコンテナのソースを参照したい
  - これまではホスト上のディレクトリをデータボリュームとしてマウントしていた
- デプロイはデータボリュームコンテナだけにしたい
  - これまではホスト上で git pull していた
- ソースの編集は docker exec -it でコンテナに入って
  - debian に日本語環境インストールが必要



## データボリュームコンテナとは



## イメージ図



## ファイル構成

```
$ tree .
.
├── docker-compose.yml
├── storage
│   └── Dockerfile
└── web
    ├── Dockerfile
    ├── docker-php.conf
    └── kaotil-default.conf
```



### データボリュームコンテナ

- storage/Dockerfile

```
FROM alpine:latest
MAINTAINER kaotil

RUN apk add --update --no-cache git \
  && mkdir -p /opt/web/html
WORKDIR /opt/web/html
RUN git clone https://github.com/kaotil/kaotil.com.git

VOLUME /opt

CMD /bin/sh
```



### apache + php Dockefile コンテナ

- web/Dockerfile

```
FROM php:7.1.3-apache
MAINTAINER kaotil

RUN apt-get update && apt-get install -y \
  vim \
  git \
  locales

RUN locale-gen ja_JP.UTF-8
ENV LANG ja_JP.UTF-8
ENV LANGUAGE ja_JP:en
ENV LC_ALL ja_JP.UTF-8
RUN localedef -f UTF-8 -i ja_JP ja_JP.UTF-8

RUN ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime

COPY kaotil-default.conf /etc/apache2/sites-available/kaotil-default.conf
RUN sed -i 's/ServerTokens OS/ServerTokens Prod/' /etc/apache2/conf-available/security.conf
RUN sed -i 's/ServerSignature On/ServerSignature Off/' /etc/apache2/conf-available/security.conf
RUN a2ensite kaotil-default.conf
RUN a2dissite 000-default.conf
RUN a2enmod rewrite

CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]

WORKDIR /opt/web/html
```



- web/docker-php.conf

```
<FilesMatch \.php$>
        SetHandler application/x-httpd-php
</FilesMatch>

DirectoryIndex disabled
DirectoryIndex index.php index.html

<Directory /opt/web/>
        Options -Indexes
        AllowOverride All
</Directory>
```



- web/kaotil-default.conf

```
<VirtualHost *:80>
    #ServerAdmin webmaster@localhost
    DocumentRoot /opt/web/html/kaotil.com

    <Directory /opt/web/html/kaotil.com>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride All
        Require all granted
        RewriteEngine On
        RewriteRule ^slides/([0-9]+)$ /slides/slide.php?id=$1 [L]
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    LogLevel info rewrite:trace8
</VirtualHost>
```




### docker-compose.yml ファイル

```
version: '2'
services:
  web:
    build: ./web
    hostname: web
    container_name: web
    ports:
      - '80:80'
    volumes_from:
      - storage
  storage:
    build: ./storage
    hostname: storage
    container_name: storage
```



## ビルド

```
- ビルドと起動
$ docker-compose build
$ docker-compose up -d

- ビルドし直す場合
$ docker-compose stop
$ docker-compose rm
$ docker-compose build --no-cache
$ docker-compose up -d

- web コンテナにログイン
$ docker exec -it web /bin/bash

- storage コンテナにログイン
$ docker run --rm -it docker_storage sh
```
