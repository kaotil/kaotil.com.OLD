# My aws - blue green deploy編

2016/05/10

kaotil@



## blue green deploymentとは
blue と green の2つの環境を用意し、片方でデプロイして確認したら、ルータやロードバランサで切り替えてます。



## イメージ
![イメージ](/slides/img/0004/aws_blue_green_deploy.png)<!-- .element: class="img_50" -->



## メリット
- ダウンタイムなし
- 問題があればすぐ元に戻せる
- 一貫性を保ちやすい
- immutable infrastructure ではプロビジョニングがシンプルになる
  - 2度と変更を加えない（使い捨て）



## デメリット
- コストがかかる
- ログは集約する仕組みがいる
- DBは切り替えるのは難易度が高い



## やり方はいくつかあります
- Weighted DNS
  - Route53のWeightを使って徐々にBlueからGreenへトラフィックを寄せる
- Swap Auto Scaling Group
  - Route53は常に同じELBを指すようにする。
  - ELBにアタッチするASGをコントロールする。
  - ASGの付け外しやインスタンス数の調整は、API経由とはいえある程度自前で作りこむ必要はあります。
- Container with Amazon ECS Service
  - Amazon EC2 Container Service (ECS)のServiceスケジューラっていうのを使ってやるらしい。



## やってみよう！



### 1. Weighted DNS
#### Route53にELB違いのレコードを2つ登録すればOK

![Weighted DNS](/slides/img/0004/aws_route53.png)<!-- .element: class="img_70" -->



#### レコード詳細
各ELBを指定してRouting Poolicyで「Weighted」を指定

Weightは任意でSet IDはユニークな値を登録

![イメージ](/slides/img/0004/aws_route53_record.png)<!-- .element: class="img_30" -->



### 注意
- TTLに注意する必要あり。
- キャッシュサーバによってはTTLを考慮せず一定期間キャッシュするものが存在するためコントロールしずらい。
- やっぱりキャッシュが効いてサクっと切り替わらない感じ
- ヘルスチェックでエラーやったらそっちには向かない
- OpsWoksで構築したらブランチがdeployになってるので注意



### 2. Swap Auto Scaling Group
Auto Scaling Groupを作ってELBを付け外しする
![イメージ](/slides/img/0004/aws_auto_scaling.png)<!-- .element: class="img_70" -->



### 注意
- OpsWorksがAuto Scaling Groupに対応してない！
  - OpsWorksにスケールの機能がある
- 動作確認時どうやってアクセスする？




### 3. Container with Amazon ECS Service 
そのうち試したい。



# まとめ
デプロイの仕組みとアプリケーションを疎結合にできて

いいですね。

