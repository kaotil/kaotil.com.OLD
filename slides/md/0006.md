# My aws - OpsWorks編

2016/00/00

kaotil@



## AWS OpsWorksとは何ですか？

AWS OpsWorksは自動化ツールを備えた柔軟な設定管理ソリューションです。

chef soleでプロビジョニングできる！<!-- .element: class="fragment" data-fragment-index="1" -->



## 使い方
- webサーバとELBの構成の場合



### 1. Stackの作成
- gitのリポジトリ指定など
- SSH keyは指定しておかないとダメ



### 2. Layersの作成
- webのレイヤー
  - Recipesの設定
  - Network でELB設定
  - Security Groupsの設定
  - カスタムCookbookを更新したら更新が必要
- ELBのレイヤー



### 3. Instancesの作成

- Instanceを作成する
  - setupに設定したレシピが実行される

これでOK!<!-- .element: class="fragment" data-fragment-index="1" -->



## LifeCycleEventについて

レシピが実行されるタイミング

- Setup
  - インスタンス起動時に1度のみ実行される
- Configure
  - 他のインスタンスが起動・停止された場合に実行される
  - 初回起動時にも実行される
- Deploy
  - アプリケーションのデプロイ時に実行される
  - 初回起動時にも実行される
- Undeploy
  - アプリケーションの削除時に実行される
- Shutdown
  - インスタンスの停止時に実行される



### デプロイ

マネージメントコンソール画面からポチポチっとデプロイが可能

- Layers > Recipes > Deploy に指定したレシピが実行される。

デプロイのレシピサンプル
```
deploy '/path/to/application' do
  repository 'git@github.com:acctname/private-repo.git'
  revision "master"
  user "nginx"
  group "nginx"
  action :deploy
end
```




## Permissions

- OpsWorksを操作するIAMユーザの設定


## Auto healingについて

- Layers > General Setting > Auto healing enabled っていう設定がある
  - OpsWorksエージェントとサービスの通信が5分以上途絶えると失敗したとみなされる
  - 代替インスタンスは障害インスタンス割り当てられたEBSを引き継ぐ
    - ログなどのデータを失わない
- この機能のせいか身に覚えのないsetupイベントが発生している



- 起動停止に時間がかかる
- Chef Soloで動いている
- /var/lib/aws/opsworks/data/nodes/配下にインスタンスごとのjsonが格納されている
  - /var/lib/aws/opsworks/data.internal/nodes/web1.localdomain.json
- data_bagsはスタックごとにOpsWorks側で設定が可能
- undeploy 5世代分までロールバック可能？
- リポジトリからではなくキャッシュからレシピを実行します
- オンラインのインスタンスには、更新したカスタムクックブックを手動でデプロイする必要があります。
- 負荷ベースのインスタンスと時間ベースのインスタンスを含め、オフラインの Instance Store-Backed インスタンスには、更新したカスタムクックブックをデプロイする必要はありません。
- 標準レシピに続けてのカスタムレシピが実行されます
- cookbookname::recipename 
- データバッグはインスタンスで JSON データとして保存されるグローバル変数です
  - /var/chef/runs/ccc3da0f-9d1b-48d0-8411-b071c75cdceb/data_bags/aws_opsworks_app/kaotilcom.json



## ファイル
- レシピ
  - /var/lib/aws/opsworks/cache.internal/cookbooks/
- ログ
  - /var/log/aws/opsworks/opsworks-agent.process_command.log
- chefのログ
  - /var/lib/aws/opsworks/chef
- OpsWorksのログ
  - /var/log/aws/opsworks
- recipes
  - https://github.com/aws/opsworks-cookbooks
- My sample stack
  - https://github.com/awslabs/opsworks-linux-demo-cookbook-nodejs
- LayerのRecipes
  - /var/chef/



## アプリケーション
- 複数設定できる。使い分けのサンプル
- Environment Variables 環境変数が設定できる




## 参考サイト
[WS OpsWorks を使ってみて分かった善し悪し](http://bynatures.net/wordpress/3920/)
[AWS OpsWorks用に作った自作レシピ](http://qiita.com/f96q@github/items/63041a8b6a22d9f491d0)

```
[root@web1 opsworks]# cat client.internal.rb
# encoding: UTF-8
ohai.plugin_path << "/opt/aws/opsworks/current/plugins"

local_mode true
log_level :info

cookbook_path ["/opt/aws/opsworks/current/cookbooks"]
file_cache_path "/var/lib/aws/opsworks/cache.internal"
node_path "/var/lib/aws/opsworks/data.internal/nodes"
data_bag_path "/var/lib/aws/opsworks/data.internal/data_bags"

%w{BUNDLE_GEMFILE GEM_HOME GEM_PATH RUBYLIB RUBYOPT}.each do |env|
  ENV[env] = nil
end

ENV['PATH'] = "/usr/local/bin:/usr/local/sbin:#{ENV['PATH']}"
```
