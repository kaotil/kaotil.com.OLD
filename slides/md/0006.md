# My aws - Amazon Inspector編

2016/00/00

kaotil@



## Amazon Inspectorとは
- AWS にデプロイされたアプリケーションのセキュリティとコンプライアンスを向上させるための、自動化されたセキュリティ評価サービスです。
- ざっくり言うと、潜在的な脆弱性がないかをルールと照合することで検査してくれるツール。
- agentのインストールが必要。



## サポートリージョン
2016年5月現在
  - EU(アイルランド)
  - アジアパシフィック(東京)
  - 米国(バージニア北部)
  - 米国(オレゴン)



## サポートOS
  - Amazon Linux (2015.03 or later)
  - Ubuntu (14.04 LTS or later)
  - Red Hat Enterprise Linux (7.2 or later)
  - CentOS (7.2 or later)
  - Windows Server 2008 R2 and Windows Server 2012



## 事前準備
0. 対象ホストへエージェントのインストール
```
$ curl -O https://d1wk0tztpsntt1.cloudfront.net/linux/latest/install
$ chmod 777 install
$ sudo ./install
```
0. Amazon Inspectorサービスロールを作成



## Amazon Inspector 実行
0. 評価ターゲットの定義
  - 評価対象のタグを指定する。
    - キー: inspector、値: on とか
- 評価テンプレートの定義
  - ルールパッケージを選択
    - 詳細は次のスライドで。<!-- .element: class="fragment" data-fragment-index="1" -->
  - 所要時間を指定
    - 自分で指定する。1時間が推奨。<!-- .element: class="fragment" data-fragment-index="2" -->
  - 結果に付けるタグを任意で指定
    - 結果が見にくくなるので付けた方がよい。<!-- .element: class="fragment" data-fragment-index="3" -->
- 評価の実行



## ルールパッケージ
選択出来るルールパッケージは4つ。(2016年5月現在)
0. Common Vulnerabilities and Exposures
0. CIS Operating System Security Configuration Benchmarks
0. Security Best Practices
0. Runtime Behavior Analysis



### 1. Common Vulnerabilities and Exposures
一般的な脆弱性と曝露

[CVEルールパッケージ](https://s3-us-west-2.amazonaws.com/rules-engine/CVEList.txt)



### 2. CIS Operating System Security Configuration Benchmarks
CISオペレーティングシステムのセキュリティ設定ベンチマーク
  - CIS：Center for Internet Security：セキュリティ構築の不具合によるビジネスやイーコマースにおける組織のリスク軽減を支援する米国の非営利組織。
  - AWSのセキュリティ設定のベストプラクティスを公開している
  - [CIS Amazon Web Services Foundations](https://d0.awsstatic.com/whitepapers/compliance/AWS_CIS_Foundations_Benchmark.pdf)
  - [あなたのAWSセキュリティ監査状況を採点〜CISベンチマークを読んでみた](http://dev.classmethod.jp/cloud/aws/reading-cis-aws-foundation-benchmark/)



### 3. Security Best Practices
セキュリティのベストプラクティス
  - システムが安全に設定されているかどうかを判断するうえで役立ちます。
    - SSH 経由の root ログインを無効化する
    - SSH バージョン 2 のみをサポート
    - SSH 経由のパスワード認証を無効化する
    - パスワードの有効期限を設定する
    - パスワードの最小文字数を設定する
    - パスワードの複雑さを設定する
    - ASLR の有効化
    - DEP の有効化
    - システムディレクトリに対するアクセス権限の設定



### 4. Runtime Behavior Analysis
実行時の動作の分析
  - 評価の実行中に、インスタンスの動作を分析し、EC2 インスタンスのセキュリティを高めるためのガイダンスを提供します。
    - 安全でないクライアントプロトコル (ログイン)
    - 安全でないクライアントプロトコル (一般)
    - 未使用のリッスンする TCP ポート
    - 安全でないサーバープロトコル
    - DEP のないソフトウェア
    - スタック Cookie がないソフトウェア
    - 安全でないアクセス権限を持つ Root プロセス



## 実行結果



## まとめ
ソースからインストールしたものは対象外になったとか、100%ではない。
[自動セキュリティ診断](http://web-cache.stream.ne.jp/www11/nikkeibpw/itpro/NCF/sample/NCF1603ServiceEvaluation.pdf)



## 備忘
- Amazon Inspector Application Limits
  - Application数は、AWSアカウント毎に50が上限です。

- Amazon Inspector Assessment Limits
  - Assessment数は、AWSアカウント毎に500が上限です。

- agent設定ファイル
```
$ cat /opt/aws/awsagent/etc/agent.cfg
{
    "ServiceEndpoint" : "arsenal.ap-northeast-1.amazonaws.com",
    "VerifySSL" : true,
    "KernelModulePath" : "/opt/aws/awsagent/kmods/amznmon64.ko",  
    "LogLevels" : "LogWarning,LogError,LogNotice",
    "SubSystems" : "AGENT,CONFIGURATION,PUBLISHER"
}
```



## 参考サイト
[GA リリースとなった Amazon Inspector の使い方をまとめました](http://blog.serverworks.co.jp/tech/2016/04/21/amazon-inspector-tutorial/)

[Amazon Inspector: Working with AWS Agents](https://docs.aws.amazon.com/inspector/latest/userguide/inspector_working-with-agents.html)


[忙しい人のためのAmazon Inspector User Guide まとめ](http://qiita.com/fnifni/items/75e0330715d3e3964557)
