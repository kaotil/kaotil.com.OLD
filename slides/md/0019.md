# My aws - 自動デプロイ編

@kaotil

2016/00/00



# やりたいこと

- github の dev ブランチにプシュ
- maseter ブランチにプルリクしてマージ
- github の webhook でデプロイスクリプト実行

- これまでは CodeDeploy で手動デプロイ
- シークレットキーを使う
- タグ切りたい
- マージした時かタグ切った時にデプロイしたい

0. GitHubにコードをpushする
0. CircleCI用のIAMユーザを作成し、アクセスキーを取得する
0. CircleCIにGitHubのリポジトリをリンクする
0. CircleCIにアクセスキーを登録する
0. ビルドを実施
0. デプロイされているはずなので、webにアクセスしてみる


## 問題

0. ecsホストのセキュリティグループがssh全許可してる


# 参考URL

- [githubのwebhookを使って、push時に自動でサーバーを更新させる](http://blog.manaten.net/entry/573)
- [CircleCI から deploy させる話](http://mgi.hatenablog.com/entry/2014/10/30/085403)
- [CircleCI+ECS+ECR環境でDockerコンテナのCD(継続的デプロイ)環境を構築する -後編-](http://dev.classmethod.jp/cloud/httpdev-classmethod-jpcloudcircleci-ecr-ecs-2/)

```
sudo easy_install pip

$ ssh-keygen -t rsa
$ pbcopy < ~/.ssh/id_rsa.pub
github > Settings > SSH and GPG keys > New SSH Key
- 接続テスト
$ ssh -T git@github.com
git remote set-url origin git@github.com:kaotil/kaotil.com.git


```



```
/etc/nginx/nginx.conf
Nginxのバージョン番号をエラーページとServer headerに含まれないようする
server_tokens off;

/etc/php.ini
// HTTPヘッダにPHPのバージョンを一緒に出さないようにする
expose_php = Off
```



- ECS
- Docker for mac
- ECS CLIとECR

- awsをコンテナ運用
- CircleCIでデプロイ
- CircleCIとServerspecでTDD
- elastic serarch + kibanaでログを可視化
- gitlabCI


## amazon linux にインストールしたもの

- locate
- tcpdump
- git
- lsof
- bind-utils
  - dig, host とかのインストール
- vim
  - vimdiffとvimのインストール
- nkf
- gcc
- wget
- postfix
- yum-utils
- telnet
- traceroute
- jq
- epel
- wget



###  参考サイト

- [NginxでHTTPS : ゼロから始めてSSLの評価をA+にするまで Part 1](http://postd.cc/https-on-nginx-from-zero-to-a-plus-part-1/)
- [Qualys SSL Report](https://www.ssllabs.com/ssltest/)
- [CIS Amazon Web Services Foundations](https://benchmarks.cisecurity.org/tools2/amazon/CIS_Amazon_Web_Services_Foundations_Benchmark_v1.0.0.pdf)
- [AWS セキュリティのベストプラクティス](https://d0.awsstatic.com/International/ja_JP/Whitepapers/AWS_Security_Best_Practices.pdf)
- [セキュリティ監査状況を採点〜CISベンチマークを読んでみた(Amazon Linux編)](http://dev.classmethod.jp/cloud/aws/reading-cis-benchmark-for-amazon-linux/)

- [CircleCI+ECS+ECR環境でDockerコンテナのCD(継続的デプロイ)環境を構築する -前編-](http://dev.classmethod.jp/cloud/circleci-ecr-ecs-1/)

- [Git プッシュから Amazon ECS に自動デプロイする仕組みを構築する](https://orih.io/2015/12/run-automated-deployment-by-git-push-with-ecs-deploy-script/)

- [CircleCI+ECS+ECR環境でDockerコンテナのCD(継続的デプロイ)環境を構築する -後編-](http://dev.classmethod.jp/cloud/httpdev-classmethod-jpcloudcircleci-ecr-ecs-2/)
- [Jenkinsを使った自動テスト環境を作る（前編）](http://knowledge.sakura.ad.jp/knowledge/5293/)

