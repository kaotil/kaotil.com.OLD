# My aws - Lambda + API Gateway + DynamoDB 前編

@kaotil

2016/00/00



## Lambda と API Gateway を使ってみたい

勉強会のスライド一覧を、API Gateway 経由で Lambda を実行して DynamoDB に登録、更新、削除、取得するするようにしよう。



### イメージ図

Java Scriptから呼び出したい

![イメージ](/slides/img/0011/lambda_diagram.png)<!-- .element: class="img_80" -->



### 1. Lambdaを始める

![Lambdaトップ](/slides/img/0011/lambda_get_start.png)<!-- .element: class="img_60" -->



### 2. blue print(ひな型) から選ぶ 

「microservice-http-endpoint」が使えそうなのでこれを選ぶ

![blue print](/slides/img/0011/lambda_select_blueprint.png)<!-- .element: class="img_60" -->



### 3. Configure triggers

![Configure triggers](/slides/img/0011/lambda_configure_triggers.png)<!-- .element: class="img_60" -->



- 設定値
  - API name: SlideService
  - Resource name: /slide
  - Method: POST
  - Deployment stage: prod
  - Security: Open

- Securityは、AWS IAM、Open、Open with access keyがあるけど、今はOpenにして後でcognitoを検討する。



### 4. Configure function 1

画面が長いので4つに分けます

![Configure function1](/slides/img/0011/lambda_configure_function1.png)<!-- .element: class="img_60" -->

- 設定値
  - Name: slideApiTest
  - Description: デフォルト値
  - Runtime: Node.js 4.3



### 4. Configure function 2

![Configure function2](/slides/img/0011/lambda_configure_function2.png)<!-- .element: class="img_60" -->

Lambda function のコードがあって



### 4. Configure function 3 

![Configure function3](/slides/img/0011/lambda_configure_function3.png)<!-- .element: class="img_60" -->

- Roleを新規で作る
  - Role name: lambda_slide_function_role
  - Policy templates: デフォルト値



### 4. Configure function 4

![Configure function4](/slides/img/0011/lambda_configure_function4.png)<!-- .element: class="img_60" -->

- 全部デフォルト値で
  - Memory(MB): 512
  - Timeout: 0min 10sec
  - VPC: No VPC



### 5. Review 

![Review](/slides/img/0011/lambda_review.png)<!-- .element: class="img_60" -->

Create functionボタンを押す



### 6. 出来た 

![Result](/slides/img/0011/lambda_result.png)<!-- .element: class="img_80" -->

APIのURLが出てる



### 7. API Gateway 確認

API Gatewayの画面見るとAPIが出来てる

![API Gateway top](/slides/img/0011/api_gateway_top.png)<!-- .element: class="img_80" -->



### 8. テストしてみる

- Lambdaの画面で、Actions > Configure test event 
- json 入力 > Save and test
```
{
    "operation": "ping"
}
```



- 「pong」が返ってきた

![test](/slides/img/0011/lambda_test.png)<!-- .element: class="img_80" -->



### 9. DynamoDB作る

![DynamoDB create table](/slides/img/0011/dynamodb_create_table.png)<!-- .element: class="img_55" -->

- テーブル名: slide_list
- プライマリキー: title / 文字列
- ソートキー: no / 数値



### 10. レコードの登録

- APIを実行してレコードを登録する
- json サンプル↓

```
{
  "operation": "create",
  "payload": {
    "TableName": "slide_list",
    "Item": {
      "title": "勉強会のスライドをマークダウンで書きたい！",
      "no": 1,
      "date": "2016/02/16",
      "description": "reveal.js を使ってマークダウンでスライドを作ります"
    }
  }
}
```



- DynamoDbの画面

レコードが登録出来されている

![DynamoDB slide_list](/slides/img/0011/dynamodb_slide_list.png)<!-- .element: class="img_80" -->



### 11. API gateway でテスト

テストをクリック

![API Gateway resource](/slides/img/0011/api_gateway_resource.png)<!-- .element: class="img_80" -->



- リクエスト本文を入力して実行
- レコードが取得出来た

![API Gateway test](/slides/img/0011/api_gateway_test.png)<!-- .element: class="img_80" -->



### put, delete, scan 



### DynamoDBのcliコマンド



### 独自ドメイン設定



### バージョンごとにする



# 参考サイト

[Amazon API Gateway の API を Cognito で認証して呼び出す](http://dev.classmethod.jp/cloud/aws/api-gateway-cognito-auth/)
[（祝）AWS LambdaのVPC利用が可能になりました](http://dev.classmethod.jp/cloud/aws/aws-lambda-vpc/)












