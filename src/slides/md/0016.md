# My macbook - Docker for mac編

@kaotil

2016/00/00



```
/etc/nginx/nginx.conf
Nginxのバージョン番号をエラーページとServer headerに含まれないようする
server_tokens off;

/etc/php.ini
// HTTPヘッダにPHPのバージョンを一緒に出さないようにする
expose_php = Off
```



###  参考サイト

- [NginxでHTTPS : ゼロから始めてSSLの評価をA+にするまで Part 1](http://postd.cc/https-on-nginx-from-zero-to-a-plus-part-1/)
- [Qualys SSL Report](https://www.ssllabs.com/ssltest/)
- [CIS Amazon Web Services Foundations](https://benchmarks.cisecurity.org/tools2/amazon/CIS_Amazon_Web_Services_Foundations_Benchmark_v1.0.0.pdf)
- [AWS セキュリティのベストプラクティス](https://d0.awsstatic.com/International/ja_JP/Whitepapers/AWS_Security_Best_Practices.pdf)
- [セキュリティ監査状況を採点〜CISベンチマークを読んでみた(Amazon Linux編)](http://dev.classmethod.jp/cloud/aws/reading-cis-benchmark-for-amazon-linux/)



## HomebrewとCaskをインストール

```
- Homebrew インストール
ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
- 確認
brew -v
- Caskインストール
brew cask --version
- Tap確認
ls /usr/local/Homebrew/Library/Taps

## Cask使い方サンプル

- JavaがCaskに存在するか
brew search java
- Java8が入る
brew cask install java
- Java7が入る
brew cask install java7
- Tap設定
brew tap caskroom/versions
- Tap確認
ls /usr/local/Homebrew/Library/Taps/caskroom
```



## Docker for Macインストール

```
- Dockerのパッケージ詳細を確認
brew search docker
- Caskroom/cask/docker 詳細を見る
brew cask info docker
※NAMEが「Docker for Mac」となっている
- インストール
brew cask install docker
- 確認
docker info
docker version
```



## Dockerコンテナ作成

```
- 作業ディレクトリ作成
mkdir -p work/docker/ec2
- Dockerfileファイル作成
touch Dockerfile
- docker-compose.ymlファイル作成
vim docker-compose.yml
    version: '2'
    services:
      ec2:
        image: amazonlinux
        command: tail -f /dev/null
        container_name: ec2
- コンテナ起動
docker-compose up -d
- コンテナ確認
docker-compose ps
- コンテナに入る
docker exec -it ec2 bash
- OSの確認
cat /etc/system-release
※Amazon Linuxになっている
- Dockerイメージの確認
docker images
- Dockerコンテナの停止
docker-compose down
```



### その他のdocker-composeコマンド

```
- YAMLに「build:」があれば、そのイメージをまとめてビルド
docker-compose build
- YAMLに「image:」があれば、そのイメージをまとめてプル
docker-compose pull
- docker-compose build, docker-compose pullをした後にdocker run
docker-compose up -d
- コンテナを指定して起動。依存関係がある場合は関係するコンテナすべてが起動する。
docker-compose up -d redmine
- 関係するコンテナすべての出力を表示
docker-compose logs
- 関係するコンテナをまとめて終了
docker-compose stop
- 関係するコンテナをまとめて削除
docker-compose rm
```



## aws cliインストール

```
- pythonのバージョン確認
python --version
- ダウンロードする
https://s3.amazonaws.com/aws-cli/awscli-bundle.zip
- インストール
sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
- 設定
aws configure
```



## イメージのコミット

```
- ECSでリポジトリ作成
web/repo

- macbookからECSリポジトリにログイン
aws ecr get-login --region ap-northeast-1

docker login -u AWS -p AQEC...-e none https://nnnnnnnnnnnn.dkr.ecr.ap-northeast-1.amazonaws.com

- docker-composeでコンテナ作成
mkdir ec2
cd ec2
tree ec2
ec2
├── Dockerfile
└── docker-compose.yml

vim docker-compose.yml
  version: '2'
  services:
    ec2:
      image: amazonlinux
      command: tail -f /dev/null
      container_name: ec2

docker-compose up -d
docker-compose ps

- コンテナにログイン
docker exec -it ec2 bash

- docker-composeでイメージ構築
docker-compose build
docker images

- タグ付け
docker tag web/repo:latest nnnnnnnnnnnn.dkr.ecr.ap-northeast-1.amazonaws.com/web/repo:latest
エラーになる
Error response from daemon: no such id: web/repo:latest

- Dockerイメージ構築
docker build -t web/repo .
Sending build context to Docker daemon  2.56 kB
Error response from daemon: The Dockerfile (Dockerfile) cannot be empty
Dockerファイルが空なのでエラー。docker-composeでのやり方を調べる。

unable to prepare context: unable to evaluate symlinks in Dockerfile path: lstat /Users/kaotil/work/docker/ec2/Dockerfile: no such file or directory
```



## memo

```
ECR_REGISTRY=454200CLI555.dkr.ecr.us-east-1.amazonaws.com
docker build -t ${ECR_REGISTRY}/${ECR_REPOSITORY} ${ECR_REPOSITORY}
docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
aws ecr list-images --repository-name ${ECR_REPOSITORY} --output text

タスクの中にコンテナがある
タスクを作るときにコンテナが作られ、コンテナの元はファイル(Dockerfileかdocker-compose.yaml)かイメージ？

- Dockerfile
FROM イメージを指定

- docker-compose.yml
image: イメージからできる
build: Dockerfileからできる 
「build:」があれば、そのイメージをまとめてビルド
「image:」があれば、そのイメージをまとめてプル

docker-compose up -d でプルされた

ecs-cli の yml ファイルでは build を使うことができません

# docker-machineのIPアドレスを確認
docker-machine ls 
```



###  参考サイト

- [macOS Sierra に Homebrew と Cask をクリーンインストールする](http://stangler.hatenablog.com/entry/2016/09/28/162747)
- [macOS Sierra に Homebrew Cask で Docker for Mac をインストールする](http://stangler.hatenablog.com/entry/2016/11/17/141705)
- [macOS Sierra に Docker for Mac で Amazon Linux を導入する](http://stangler.hatenablog.com/entry/2016/11/17/165803)
- [AWS CLIをMACにインストールする](http://qiita.com/mogetarou/items/71c0ef4dd8669209d5cd)

- [docker-composeを使って最高の開発環境を手に入れた](http://blog.muuny-blue.info/7d128c1d4a33165a8676d1650d8ff828.html)
- [Docker Compose - docker-compose.yml リファレンス](http://qiita.com/zembutsu/items/9e9d80e05e36e882caaa)

- [ECS CLIを使ってDocker Composeのファイルを使ってECSにデプロイする](http://qiita.com/toshihirock/items/824a86da51015350a051#%E5%8F%82%E8%80%83)

- [macOS Sierra に Docker for Mac で Amazon Linux を導入する](http://stangler.hatenablog.com/entry/2016/11/17/165803)

- [ECS CLIを使ってDocker Composeのファイルを使ってECSにデプロイする](http://qiita.com/toshihirock/items/824a86da51015350a051)

- [Amazon ECS CLI を使い Rocket.Chat 環境を compose するには](http://pocketstudio.jp/log3/2015/10/14/amazon-ecs-cli-compose-rocket-chat/)
- [Amazon ECS CLI Tutorial](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_CLI_tutorial.html)
- [ECS 上に自分が作成した docker-compose アプリをデプロイしてみる](http://hawksnowlog.blogspot.jp/2017/01/original-compose-app-deployed-ecs.html)
- []()


## amazon linux にインストールしたもの

- locate
- tcpdump
- git
- lsof
- bind-utils
  - dig, host とかのインストール
- vim
  - vimdiffとvimのインストール
- nkf
- gcc
- wget
- postfix
- yum-utils
- telnet
- traceroute
- jq
- epel
- wget
